stages:
  - typing
  - linting
  - testing
  - pages
  - build

image: docker:24.0.5
services:
    - docker:24.0.5-dind

.standard-rules:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""

before_script:
  - apk add --no-cache docker-compose
  - docker version
  - docker-compose --version
  - cd backend
  - docker-compose up -d

backend-typnig:
  stage: typing
  rules:
    - if: $CI_COMMIT_MESSAGE
  script:
    - sleep 5s
    - docker exec -t backend pdm run mypy .

backend-linting:
  stage: linting
  rules:
    - if: $CI_COMMIT_MESSAGE
  script:
    - sleep 5s
    - docker exec -t backend pdm run ruff check .

backend-testing:
  stage: testing
  rules:
    - if: $CI_COMMIT_MESSAGE
  script:
    - docker exec -t backend pdm run pytest --cov --junitxml=junit.xml --cov-report xml
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    when: always
    paths:
      - /backend/src/junit.xml
      - /backend/src/coverage.xml
    reports:
      junit: junit.xml
      coverage_report: coverage.xml

