ARG PYTHON_BASE=3.13-slim-bookworm
# build stage
FROM python:$PYTHON_BASE AS builder

# install uv
RUN apt-get update && apt-get install -y --no-install-recommends curl ca-certificates
ADD https://astral.sh/uv/install.sh /uv-installer.sh
RUN sh /uv-installer.sh && rm /uv-installer.sh

# Ensure the installed binary is on the `PATH`
ENV PATH="/root/.local/bin/:$PATH"

# set work directory
WORKDIR /backend/src
WORKDIR /backend/src
# set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1
# install psycopg2 dependencies
RUN apt-get update \
    && apt-get install -y postgresql-server-dev-all gcc python3-dev musl-dev
# install dependencies
RUN pip install --upgrade pip
COPY ../requirements.txt ../pyproject.toml ../pdm.lock ../entrypoint.sh ../
RUN pip3 install -r ../requirements.txt
ENTRYPOINT ["/backend/entrypoint.sh" ]
# copy project
COPY src/ src/
